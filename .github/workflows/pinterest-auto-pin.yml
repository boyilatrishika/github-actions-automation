name: Auto-Generate and Post to Pinterest
on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 9 AM UTC
  workflow_dispatch:
    inputs:
      test_mode:
        type: boolean
        default: false
        required: false
        description: 'Run in test mode (no actual pin created)')'
  pinterest-auto-pin:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pillow
      
      - name: Generate AI Image using free API
        run: |
          python3 << 'EOF'
          import requests
          from datetime import datetime
          import random
          
          api_key = "${{ secrets.PIXABAY_API_KEY }}"
          search_query = "AI technology innovation"
          
          # Fetch image from Pixabay
          url = f"https://pixabay.com/api/?key={api_key}&q={search_query}&image_type=illustration&per_page=3"
          response = requests.get(url)
          
          if response.status_code == 200:
              data = response.json()
              if data['hits']:
                  # Pick a random image
                  image = random.choice(data['hits'])
                  image_url = image['largeImageURL']
                  img_response = requests.get(image_url)
                  with open('pin_image.png', 'wb') as f:
                      f.write(img_response.content)
                  print(f"Image downloaded successfully")
                  print(f"Image URL: {image_url}")
              else:
                  print("No images found")
          EOF
      
      - name: Create Pin on Pinterest
        run: |
          python3 << 'EOF'
          import requests
          import json
          import os
          from datetime import datetime
          
          # Pinterest API Configuration
          access_token = "${{ secrets.PINTEREST_ACCESS_TOKEN }}"
          board_id = "${{ secrets.PINTEREST_BOARD_ID }}"
          
          # Pin details
          title = f"AI Innovation Daily Pin - {datetime.now().strftime('%Y-%m-%d')}"
          description = "Explore cutting-edge AI tools and automation technologies."
          link = "https://www.example.com"
          image_path = "pin_image.png"
          
          if not access_token or access_token == "":
              print("❌ PINTEREST_ACCESS_TOKEN not configured!")
              print("\nTo enable automatic posting:")
              print("1. Get your Pinterest access token from: https://developers.pinterest.com/")
              print("2. Add it as PINTEREST_ACCESS_TOKEN secret in GitHub")
              print("3. Re-run the workflow")
          else:
              try:
                  # Prepare the API request
                  api_url = f"https://api.pinterest.com/v5/pins"
                  
                  headers = {
                      "Authorization": f"Bearer {access_token}",
                      "Content-Type": "application/json"
                  }
                  
                  payload = {
                      "title": title,
                      "description": description,
                      "link": link,
                      "board_id": board_id,
            "media_source": {
                "source_type": "image_url",
                "url": image_url
                        }
        }
                  # Post to Pinterest
                  response = requests.post(api_url, headers=headers, json=payload)
                  
                                                      print(f"API Status Code: {response.status_code}")
                  
                  if response.status_code in [200, 201]:
                      print("✅ PIN CREATED SUCCESSFULLY!")
                      print(f"Title: {title}")
                      print(f"Description: {description}")
                      result = response.json()
                      if 'id' in result:
                          print(f"Pin ID: {result['id']}")
                  else:
                      print(f"❌ Failed to create pin")
                      print(f"Response: {response.text}")
                  
              except Exception as e:
                  print(f"❌ Error: {str(e)}")
          EOF
      
      - name: Cleanup
        if: always()
        run: |
          rm -f pin_image.png
