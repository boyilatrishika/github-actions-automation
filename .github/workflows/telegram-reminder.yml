name: Telegram Daily Reminder

on:
  schedule:
    # 2:30 AM UTC = 8:00 AM IST (UTC+5:30)
    - cron: '30 2 * * *'
  workflow_dispatch:

jobs:
  send-reminder:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check current time in Asia/Kolkata timezone
        id: timezone-check
        run: |
          # Get current time in Asia/Kolkata timezone
          CURRENT_TIME=$(TZ='Asia/Kolkata' date '+%H:%M:%S')
          CURRENT_HOUR=$(TZ='Asia/Kolkata' date '+%H')
          
          echo "Current time in IST: $CURRENT_TIME"
          echo "Current hour: $CURRENT_HOUR"
          
          # Check if current hour is 08 (8 AM)
          if [ "$CURRENT_HOUR" = "08" ]; then
            echo "Time check passed: Current hour is 08:XX IST"
            echo "should_send=true" >> $GITHUB_OUTPUT
          else
            echo "Time check failed: Current hour is $CURRENT_HOUR IST (expected 08)"
            echo "should_send=false" >> $GITHUB_OUTPUT
          fi

      - name: Debug - Display current UTC and IST times
        run: |
          echo "=== Timezone Information ==="
          echo "Current UTC time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Current IST time: $(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S IST')"
          echo "Scheduled cron: 30 2 * * * (2:30 AM UTC)"
          echo "Expected trigger time: 8:00 AM IST"
          echo ""

      - name: Send Telegram reminder message
        if: steps.timezone-check.outputs.should_send == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "Sending Telegram reminder message..."
          
          curl -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"text\": \"☀️ Good morning! Time to start your day!\",
              \"parse_mode\": \"HTML\"
            }"
          
          echo ""
          echo "Message sent successfully!"

      - name: Skip message (wrong hour)
        if: steps.timezone-check.outputs.should_send == 'false'
        run: |
          echo "⏭️  Skipping message send - not at 8 AM IST yet"
          CURRENT_HOUR=$(TZ='Asia/Kolkata' date '+%H')
          echo "Current hour in IST: $CURRENT_HOUR (expected: 08)"
