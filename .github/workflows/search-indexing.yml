name: Search Engine Indexing Automation

on:
  schedule:
    # Runs daily at 03:00 UTC (8:30 AM IST)
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: 'false'

jobs:
  index-urls:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      DOMAIN_URL: ${{ secrets.DOMAIN_URL }}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      BING_API_KEY: ${{ secrets.BING_API_KEY }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Create GCP service account key file
        run: |
          echo "${{ secrets.GCP_SA_KEY }}" > /tmp/gcp-key.json
          cat /tmp/gcp-key.json | python3 -m json.tool > /dev/null && echo "‚úì GCP key is valid JSON" || echo "‚úó GCP key validation failed"
      
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client requests
      
      - name: Load URLs from file
        id: load_urls
        run: |
          if [ -f "urls.txt" ]; then
            URLS=$(cat urls.txt | grep -v '^#' | grep -v '^$' | tr '\n' '|' | sed 's/|$//')
            echo "url_list=$URLS" >> $GITHUB_OUTPUT
            URL_COUNT=$(cat urls.txt | grep -v '^#' | grep -v '^$' | wc -l)
            echo "‚úì Loaded $URL_COUNT URLs from urls.txt"
          else
            echo "‚úó urls.txt not found"
            exit 1
          fi
      
      - name: Submit URLs to Google Search Console
        id: google_submission
        continue-on-error: true
        run: |
          python3 << 'EOF'
          import json
          import os
          from google.auth.transport.requests import Request
          from google.oauth2.service_account import Credentials
          from googleapiclient.discovery import build
          import sys
          
          debug = "${{ github.event.inputs.debug_mode }}" == "true"
          
          try:
              # Load service account credentials
              with open('/tmp/gcp-key.json', 'r') as f:
                  service_account_info = json.load(f)
              
              # Create credentials
              credentials = Credentials.from_service_account_info(
                  service_account_info,
                  scopes=['https://www.googleapis.com/auth/indexing']
              )
              
              # Get access token
              credentials.refresh(Request())
              
              # Load URLs
              urls = []
              if os.path.exists('urls.txt'):
                  with open('urls.txt', 'r') as f:
                      urls = [line.strip() for line in f if line.strip() and not line.startswith('#')]
              
              if not urls:
                  print("‚úó No URLs found to submit")
                  sys.exit(1)
              
              # Submit each URL
              successful = 0
              failed = 0
              
              for url in urls:
                  try:
                      import requests
                      headers = {
                          'Content-Type': 'application/json',
                          'Authorization': f'Bearer {credentials.token}'
                      }
                      body = {
                          'url': url,
                          'type': 'URL_UPDATED'
                      }
                      
                      response = requests.post(
                          'https://indexing.googleapis.com/v3/urlNotifications:publish',
                          json=body,
                          headers=headers,
                          timeout=10
                      )
                      
                      if response.status_code == 200:
                          print(f"‚úì Google: {url}")
                          successful += 1
                      else:
                          print(f"‚úó Google: {url} - Status {response.status_code}")
                          if debug:
                              print(f"  Response: {response.text}")
                          failed += 1
                  except Exception as e:
                      print(f"‚úó Google: {url} - Error: {str(e)}")
                      failed += 1
              
              print(f"\nüìä Google Search Console: {successful} succeeded, {failed} failed")
              
          except Exception as e:
              print(f"‚úó Google submission error: {str(e)}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          EOF
      
      - name: Submit URLs to Bing Webmaster Tools
        id: bing_submission
        continue-on-error: true
        run: |
          python3 << 'EOF'
          import requests
          import os
          import sys
          
          debug = "${{ github.event.inputs.debug_mode }}" == "true"
          bing_api_key = "${{ secrets.BING_API_KEY }}"
          
          if not bing_api_key:
              print("‚úó BING_API_KEY not configured")
              sys.exit(1)
          
          # Load URLs
          urls = []
          if os.path.exists('urls.txt'):
              with open('urls.txt', 'r') as f:
                  urls = [line.strip() for line in f if line.strip() and not line.startswith('#')]
          
          if not urls:
              print("‚úó No URLs found to submit")
              sys.exit(1)
          
          successful = 0
          failed = 0
          
          for url in urls:
              try:
                  headers = {
                      'Content-Type': 'application/json'
                  }
                  params = {
                      'apikey': bing_api_key
                  }
                  body = {
                      'siteUrl': "${{ secrets.DOMAIN_URL }}",
                      'urlList': [url]
                  }
                  
                  response = requests.post(
                      'https://ssl.bing.com/webmaster/api.svc/json/SubmitUrlBatch',
                      json=body,
                      headers=headers,
                      params=params,
                      timeout=10
                  )
                  
                  if response.status_code in [200, 201]:
                      print(f"‚úì Bing: {url}")
                      successful += 1
                  else:
                      print(f"‚úó Bing: {url} - Status {response.status_code}")
                      if debug:
                          print(f"  Response: {response.text}")
                      failed += 1
              except Exception as e:
                  print(f"‚úó Bing: {url} - Error: {str(e)}")
                  failed += 1
          
          print(f"\nüìä Bing Webmaster: {successful} succeeded, {failed} failed")
          
          if failed > 0 and successful == 0:
              sys.exit(1)
          EOF
      
      - name: Summary
        if: always()
        run: |
          echo "## üîç Search Engine Indexing Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "- Google Search Console: ${{ steps.google_submission.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- Bing Webmaster Tools: ${{ steps.bing_submission.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "Visit [Google Search Console](https://search.google.com/search-console) or [Bing Webmaster Tools](https://www.bing.com/webmasters) to verify indexing status." >> $GITHUB_STEP_SUMMARY
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ö†Ô∏è Search engine indexing automation encountered errors"
          echo "Check the logs above for details"
          exit 1
